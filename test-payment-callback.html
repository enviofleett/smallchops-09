<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Callback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        .error {
            background: #ffeee8;
            border-color: #f44336;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8a;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Payment Callback Error Investigation</h1>
        <p>Testing fixes for transaction: <code>txn_1755858631052_cedc24a3</code></p>
        
        <div class="test-case">
            <h3>1. CSP Test - Paystack Button Stylesheet</h3>
            <p>Testing if Paystack button stylesheet can load from paystack.com</p>
            <link rel="stylesheet" href="https://paystack.com/public/css/button.min.css" id="paystack-css">
            <button onclick="testCSP()">Test Paystack CSS Loading</button>
            <div id="csp-result"></div>
        </div>

        <div class="test-case">
            <h3>2. Storage Availability Test</h3>
            <p>Testing sessionStorage and localStorage availability</p>
            <button onclick="testStorage()">Test Storage</button>
            <div id="storage-result"></div>
        </div>

        <div class="test-case">
            <h3>3. Payment URL Parsing Test</h3>
            <p>Testing callback URL parameter extraction</p>
            <button onclick="testUrlParsing()">Test URL Parsing</button>
            <div id="url-result"></div>
        </div>

        <div class="test-case">
            <h3>4. Error Handling Test</h3>
            <p>Testing error message enhancement</p>
            <button onclick="testErrorHandling()">Test Error Messages</button>
            <div id="error-result"></div>
        </div>

        <div class="test-case">
            <h3>Console Output</h3>
            <pre id="console-output"></pre>
        </div>
    </div>

    <script>
        let consoleOutput = '';
        
        // Override console to capture output
        const originalConsole = console;
        console.log = function(...args) {
            consoleOutput += args.join(' ') + '\n';
            document.getElementById('console-output').textContent = consoleOutput;
            originalConsole.log(...args);
        };
        
        console.error = function(...args) {
            consoleOutput += 'ERROR: ' + args.join(' ') + '\n';
            document.getElementById('console-output').textContent = consoleOutput;
            originalConsole.error(...args);
        };

        function testCSP() {
            const cssLink = document.getElementById('paystack-css');
            const result = document.getElementById('csp-result');
            
            setTimeout(() => {
                // Check if CSS loaded successfully
                if (cssLink.sheet && cssLink.sheet.cssRules) {
                    result.innerHTML = '<div class="success">‚úÖ Paystack CSS loaded successfully</div>';
                    console.log('‚úÖ CSP allows Paystack button stylesheet');
                } else {
                    result.innerHTML = '<div class="error">‚ùå Paystack CSS blocked by CSP</div>';
                    console.error('‚ùå CSP blocking Paystack button stylesheet');
                }
            }, 1000);
        }

        function testStorage() {
            const result = document.getElementById('storage-result');
            let output = '';

            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'value');
                sessionStorage.removeItem('test');
                output += '<p>‚úÖ SessionStorage: Available</p>';
                console.log('‚úÖ SessionStorage available');
            } catch (e) {
                output += '<p>‚ùå SessionStorage: Not available - ' + e.message + '</p>';
                console.error('‚ùå SessionStorage error:', e);
            }

            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                localStorage.removeItem('test');
                output += '<p>‚úÖ LocalStorage: Available</p>';
                console.log('‚úÖ LocalStorage available');
            } catch (e) {
                output += '<p>‚ùå LocalStorage: Not available - ' + e.message + '</p>';
                console.error('‚ùå LocalStorage error:', e);
            }

            // Test Datadog SDK scenario
            if (window.DD_RUM) {
                output += '<p>‚úÖ Datadog SDK detected</p>';
                console.log('‚úÖ Datadog SDK present');
            } else {
                output += '<p>‚ö†Ô∏è Datadog SDK not detected (this is normal)</p>';
                console.log('‚ö†Ô∏è No Datadog SDK detected');
            }

            result.innerHTML = output;
        }

        function testUrlParsing() {
            const result = document.getElementById('url-result');
            const testUrl = 'https://startersmallchops.com/payment/callback?reference=txn_1755858631052_cedc24a3&status=success&order_id=cedc24a3-6794-491f-b7a6-dc33c83e5cb8';
            
            try {
                const url = new URL(testUrl);
                const params = new URLSearchParams(url.search);
                
                const reference = params.get('reference');
                const status = params.get('status');
                const orderId = params.get('order_id');
                
                let output = `
                    <p><strong>Test URL:</strong> ${testUrl}</p>
                    <p><strong>Reference:</strong> ${reference}</p>
                    <p><strong>Status:</strong> ${status}</p>
                    <p><strong>Order ID:</strong> ${orderId}</p>
                `;
                
                if (reference && status && orderId) {
                    output += '<div class="success">‚úÖ All parameters extracted successfully</div>';
                    console.log('‚úÖ URL parsing successful');
                } else {
                    output += '<div class="error">‚ùå Missing parameters</div>';
                    console.error('‚ùå URL parsing failed');
                }
                
                result.innerHTML = output;
            } catch (e) {
                result.innerHTML = '<div class="error">‚ùå URL parsing error: ' + e.message + '</div>';
                console.error('‚ùå URL parsing error:', e);
            }
        }

        function testErrorHandling() {
            const result = document.getElementById('error-result');
            const testReference = 'txn_1755858631052_cedc24a3';
            
            // Simulate different error scenarios
            const errorScenarios = [
                { error: new Error('Failed to fetch'), expected: 'Network connection issue' },
                { error: new Error('Payment verification timed out after 30000ms'), expected: 'Payment verification timed out' },
                { error: new Error('reference not found'), expected: 'Payment reference' },
                { error: new Error('Internal Server Error'), expected: 'Server temporarily unavailable' }
            ];
            
            let output = '';
            
            errorScenarios.forEach((scenario, index) => {
                const errorMessage = getEnhancedErrorMessage(scenario.error, testReference);
                const isCorrect = errorMessage.includes(scenario.expected);
                
                output += `
                    <div class="${isCorrect ? 'success' : 'error'}">
                        <strong>Test ${index + 1}:</strong> ${scenario.error.message}<br>
                        <strong>Enhanced Message:</strong> ${errorMessage}<br>
                        ${isCorrect ? '‚úÖ Correct enhancement' : '‚ùå Enhancement failed'}
                    </div>
                `;
            });
            
            result.innerHTML = output;
            console.log('‚úÖ Error handling tests completed');
        }

        // Enhanced error messaging function (copied from our implementation)
        function getEnhancedErrorMessage(error, reference) {
            const errorMessage = error?.message || error?.toString() || 'Unknown error';
            
            if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                return 'Network connection issue. Please check your internet connection and try again.';
            }
            
            if (errorMessage.includes('timed out') || errorMessage.includes('timeout')) {
                return 'Payment verification timed out. Your payment may still be processing. Please check your order history.';
            }
            
            if (errorMessage.includes('reference') || errorMessage.includes('not found')) {
                return `Payment reference (${reference.substring(0, 10)}...) could not be found. If you completed payment, please contact support.`;
            }
            
            if (errorMessage.includes('500') || errorMessage.includes('Internal Server Error')) {
                return 'Server temporarily unavailable. Your payment may have been processed. Please check your order history.';
            }
            
            return `Payment verification failed (Ref: ${reference.substring(0, 10)}...). If you completed payment, please contact support.`;
        }

        // Initialize console output
        console.log('üß™ Payment Callback Test Page Loaded');
        console.log('üîç Ready to test transaction: txn_1755858631052_cedc24a3');
    </script>
</body>
</html>